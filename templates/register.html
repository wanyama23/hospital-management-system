<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Check-In & Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .section-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem; }
    .form-box { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row g-4">
      
      <!-- ‚úÖ Existing Patient Section -->
      <div class="col-md-5">
        <div class="form-box">
          <div class="section-title">Existing Patient</div>
          <form method="POST" action="{{ url_for('checkin') }}">
            <label for="card_number" class="form-label">Patient Card Number</label>
            <input type="text" name="card_number" id="card_number" class="form-control mb-3" placeholder="e.g. HCO01234" required>
            <button type="submit" class="btn btn-primary w-100">Search & Send to Doctor</button>
          </form>

          <!-- Flash Messages -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} mt-3" role="alert">
                  {{ message }}
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}
        </div>
      </div>

      <!-- ‚úÖ New Patient Registration Section -->
      <div class="col-md-7">
        <div class="form-box">
          <div class="section-title">New Patient</div>
          <form method="POST" action="{{ url_for('register') }}">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="first_name" class="form-label">First Name</label>
                <input type="text" name="first_name" id="first_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="last_name" class="form-label">Last Name</label>
                <input type="text" name="last_name" id="last_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="medical_record_number" class="form-label">Medical Record Number</label>
                <input type="text" name="medical_record_number" id="medical_record_number" class="form-control" value="{{ generated_mrn }}" readonly>
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" name="email" id="email" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="contact" class="form-label">Phone</label>
                <input type="text" name="contact" id="contact" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="dob" class="form-label">Date of Birth</label>
                <input type="date" name="dob" id="dob" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="age" class="form-label">Age</label>
                <input type="number" name="age" id="age" class="form-control" readonly required>
              </div>
              <div class="col-md-6">
                <label for="gender" class="form-label">Gender</label>
                <select name="gender" id="gender" class="form-select" required>
                  <option value="">Select gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="blood_type" class="form-label">Blood Type</label>
                <select name="blood_type" id="blood_type" class="form-select">
                  <option value="">Select blood type</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="address" class="form-label">Address</label>
                <input type="text" name="address" id="address" class="form-control" required>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="requires_admission" id="requires_admission">
                  <label class="form-check-label" for="requires_admission">
                    Patient requires admission (emergency/labor/surgery)
                  </label>
                </div>
              </div>
            </div>

            <div class="mt-4 d-flex justify-content-between">
              <button type="submit" class="btn btn-success">Register</button>
            </div>
          </form>

          <!-- ‚úÖ Patient Card -->
          {% if patient_card %}
          <div class="card mt-4 p-3 border">
            <h5 class="mb-3">Patient Card</h5>
            <p><strong>Name:</strong> {{ patient_card.first_name }} {{ patient_card.last_name }}</p>
            <p><strong>MRN:</strong> {{ patient_card.mrn }}</p>
            <p><strong>Age:</strong> {{ patient_card.age }}</p>
            <p><strong>Gender:</strong> {{ patient_card.gender }}</p>
            <p><strong>Phone:</strong> {{ patient_card.contact }}</p>
            <button onclick="window.print()" class="btn btn-outline-secondary mt-2">üñ®Ô∏è Print Card</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Registration Success Modal -->
  <div class="modal fade" id="registrationSuccess" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Registration Successful</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Patient <strong>{{ patient_card.first_name }} {{ patient_card.last_name }}</strong> has been registered.</p>
          <p>MRN: <strong>{{ patient_card.mrn }}</strong></p>
          <p>They‚Äôve been added to the doctor‚Äôs queue.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Auto-fill Age from DOB -->
  <script>
    document.getElementById('dob').addEventListener('change', function () {
      const dob = new Date(this.value);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
        age--;
      }
      document.getElementById('age').value = age > 0 ? age : '';
    });
  </script>

  <!-- Show Modal if Patient Registered -->
  <!-- {% if patient_card %}
  <script>
    const modal = new bootstrap.Modal(document.getElementById('registrationSuccess'));
    modal.show();
  </script>
  {% endif %} -->
  {% if request.args.get('show_modal') == 'true' %}
<script>
  window.onload = function() {
    $('#confirmationModal').modal('show');
  };
</script>

<!-- Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Registration Successful</h5></div>
      <div class="modal-body">
        <p>Patient has been registered successfully.</p>
        <a href="{{ url_for('print_card', patient_id=request.args.get('patient_id')) }}" target="_blank" class="btn btn-primary">Print Patient Card</a>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% if show_modal == 'true' and patient_card %}
<script>
  window.onload = function() {
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    modal.show();
  };
</script>

<!-- Registration Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="confirmationModalLabel">Patient Registered</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>{{ patient_card.first_name }} {{ patient_card.last_name }}</strong> has been registered successfully.</p>
        <p><strong>MRN:</strong> {{ patient_card.medical_record_number }}</p>
        <p><strong>Age:</strong> {{ patient_card.age }}</p>
        <p><strong>Gender:</strong> {{ patient_card.gender }}</p>
        <p><strong>Contact:</strong> {{ patient_card.contact }}</p>
        <p><strong>Address:</strong> {{ patient_card.address }}</p>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('print_card', patient_id=patient_card.id) }}" target="_blank" class="btn btn-primary" onclick="window.open(this.href); return false;">üñ®Ô∏è Print Patient Card</a>
        <a href="{{ url_for('doctor_dashboard', patient_id=patient_card.id) }}" class="btn btn-success">üë®‚Äç‚öïÔ∏è Send to Doctor</a>
      </div>
    </div>
  </div>
</div>
{% endif %}

</body>
</html>



